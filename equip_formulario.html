<script>
  // === CONFIG API (Apps Script) ===
  const API_URL   = "https://script.google.com/macros/s/AKfycbx7K_63QoHC_F8kR3X8NczNlkLNxebsmivoxDq1LEpgBRsvTqGnPGYxqUB2JqiiW2mkZg/exec";
  const API_TOKEN = "pncqalpha123";

  // ===== Helpers =====
  function qs(k){ return new URLSearchParams(location.search).get(k); }
  function el(s){ return document.querySelector(s); }
  function esc(s){ return (s||"").toString().replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function formatDateBR(s){
    const v=(s||"").toString().trim();
    if(!v) return "";
    const iso=v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(iso) return `${iso[3]}/${iso[2]}/${iso[1]}`;
    return v;
  }

  // ===== Chamada API =====
  async function fetchEquipById(id){
    const lic = window.__QRMANUT_LICENSE__ || {};
    const url = `${API_URL}?id=${encodeURIComponent(id)}&token=${encodeURIComponent(API_TOKEN)}&licenseKey=${encodeURIComponent(lic.licenseKey||'LIC-2025-0001')}`;
    console.log("ðŸ”— GET:", url);
    const res  = await fetch(url, { method:'GET', cache:'no-store' });
    const json = await res.json();
    if(!json.ok){
      console.error("GET falhou:", json);
      throw new Error(json.error||'api_error');
    }
    return json.data;
  }

  async function enviarAnomalia(idEquipamento, descricao, reportadoPor) {
    const lic = window.__QRMANUT_LICENSE__ || {};
    const payload = {
      token: API_TOKEN,
      licenseKey: lic.licenseKey || "LIC-2025-0001",
      id: idEquipamento,
      descricao: descricao,
      reportadoPor: reportadoPor || ""
    };
    console.log("ðŸ“¤ POST payload:", payload);
    const res  = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
    const json = await res.json();
    if (!json.ok) {
      console.error("POST falhou:", json);
      throw new Error(json.error || "post_error");
    }
    return true;
  }

  // ===== Render =====
  function render(eq){
    if(!eq){ el("#titulo").textContent = "Ativo nÃ£o encontrado"; return; }

    const id   = (eq.id || "").toString().trim();
    const nome = (eq.nome_do_equipamento || "").toString().trim();
    el("#titulo").textContent = (id || "Equipamento") + (nome ? " â€“ " + nome : "");

    const fabricante=(eq.fabricante||"").toString().trim();
    const modelo    =(eq.modelo||"").toString().trim();
    el("#meta").innerHTML=[fabricante,modelo].filter(Boolean).join("<br>");

    const pares = [
      ["Fabricante", fabricante],
      ["Modelo", modelo],
      ["Capacidade", (eq.capacidade||"").toString().trim()],
      ["Amperagem Nominal (FLA)", (eq.amperagem_nominal_fla||"").toString().trim()],
      ["Voltagem", (eq.voltagem||"").toString().trim()],
    ];

    el("#carac").innerHTML =
      pares.filter(([k,v]) => v && v!=="-")
           .map(([k,v]) => k==="Modelo"
             ? `<div><b>${esc(k)}:</b></div><div style="grid-column:1 / -1;word-break:break-word;overflow-wrap:anywhere;">${esc(v)}</div>`
             : `<div><b>${esc(k)}:</b></div><div>${esc(v)}</div>`).join("")
      || "<div class='empty'>Sem dados</div>";

    const periodicidade = (eq.periodicidade||"").toString().trim();
    const prox          = formatDateBR(eq.proxima_manutencao);
    const pp = [];
    if (periodicidade) pp.push(`<b>Periodicidade:</b> ${esc(periodicidade)}`);
    if (prox)          pp.push(`<b>PrÃ³xima:</b> ${esc(prox)}`);
    el("#pp").innerHTML = pp.length ? pp.join("<br>") : "<span class='empty'>-</span>";

    el("#localizacao").textContent = (eq.localizacao || "-");
    el("#resp").textContent        = (eq.prestador   || "-");
    el("#ft").innerHTML            = "Ãšltima atualizaÃ§Ã£o: " + new Date().toLocaleString();
  }

  // ===== Boot =====
  async function main(){
    const idQ = qs("id");
    if(!idQ){ el("#titulo").textContent = "Sem ID na URL"; return; }
    try{
      const eq = await fetchEquipById(idQ);
      render(eq);
    }catch(e){
      console.error(e);
      el("#titulo").textContent = "Erro ao carregar dados";
    }
  }

  // Liga o botÃ£o "Reportar anomalia"
  document.getElementById("reportar").addEventListener("click", async () => {
    const btn = document.getElementById("reportar");
    try {
      const idEquip = (qs("id") || "").trim();
      if (!idEquip) { alert("ID ausente na URL."); return; }
      const descr = prompt("Descreva a anomalia:");
      if (!descr || !descr.trim()) return;
      const quem = prompt("Seu nome (opcional):") || "";
      btn.classList.add("disabled"); btn.style.pointerEvents="none"; btn.style.opacity="0.6";
      await enviarAnomalia(idEquip, descr.trim(), quem.trim());
      alert("Anomalia registrada com sucesso!");
    } catch (e) {
      console.error(e);
      alert("Falha ao registrar anomalia.");
    } finally {
      btn.classList.remove("disabled"); btn.style.pointerEvents="auto"; btn.style.opacity="1";
    }
  });

  document.addEventListener("DOMContentLoaded", main);
</script>
