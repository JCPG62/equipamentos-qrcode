<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ficha do Equipamento (QRManut + API)</title>
  <style>
    :root { --gap:16px; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:960px;margin:auto;padding:var(--gap);background:#f8f9fb;}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:var(--gap);box-shadow:0 6px 16px rgba(0,0,0,.05);}
    h1{font-size:1.25rem;margin:0 0 4px 0}
    .muted{color:#6b7280}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-top:var(--gap);}
    @media (max-width:780px){ .grid{grid-template-columns:1fr} }
    .chip{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;margin-right:6px;text-decoration:none;color:#111827;cursor:pointer}
    .empty{color:#9ca3af}
    .kv{display:grid;grid-template-columns:220px 1fr;gap:8px;align-items:start}
    .kv div{padding:4px 0;border-bottom:1px dashed #eee}
    .footer{margin-top:var(--gap);font-size:.9rem;color:#6b7280}
    .badge{display:inline-block;padding:2px 8px;border-radius:8px;font-size:.85em;border:1px solid #e5e7eb;vertical-align:middle}
    .badge.due{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .badge.soon{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .badge.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
  </style>
</head>
<body>

  <!-- ====== BLOCO DE LICEN√áA ====== -->
  <script id="qrmanut-license" type="application/json">
  {
    "clientId": "qrmanut_demo",
    "licenseKey": "LIC-2025-0001",
    "domains": ["jcpg62.github.io", "www.jcpg62.github.io"],
    "features": ["basic","reports"],
    "issuedAt": "2025-11-01T12:00:00Z",
    "expiresAt": "2026-11-01T12:00:00Z",
    "maxDevices": 500,
    "nonce": "demo-nonce"
  }
  </script>
  <script>
    function readLicense(){const el=document.getElementById("qrmanut-license");try{return el?JSON.parse(el.textContent):null;}catch{return null}}
    function hostnameOk(lic){const host=location.hostname||"file://";return (lic.domains||[]).includes(host)}
    function notExpired(lic){return Date.now()<=new Date(lic.expiresAt).getTime()}
    async function validateOnline(){return {ok:true,status:"offline"}}
    async function enforceLicense(){
      const lic=readLicense(); const card=document.querySelector(".card")||document.body;
      if(!lic){card.innerHTML="<h1>Licen√ßa ausente</h1>"; throw new Error("no license")}
      if(!hostnameOk(lic)){card.innerHTML="<h1>Dom√≠nio n√£o autorizado</h1>"; throw new Error("host")}
      if(!notExpired(lic)){card.innerHTML="<h1>Licen√ßa expirada</h1>"; throw new Error("expired")}
      window.__QRMANUT_LICENSE__=lic;
      validateOnline(lic.licenseKey).then(r=>{ if(r.status==='revoked'){ document.body.innerHTML="<h1>Licen√ßa revogada</h1>"; }});
    }
    enforceLicense().catch(console.error);
  </script>
  <!-- ====== FIM BLOCO DE LICEN√áA ====== -->

  <div class="card">
    <h1 id="titulo">Carregando‚Ä¶</h1>
    <div id="meta" class="muted"></div>

    <div class="grid">
      <div>
        <h3>Caracter√≠sticas</h3>
        <div id="carac" class="kv"></div>

        <h3>Plano Preventivo</h3>
        <div id="pp" class="empty">Periodicidade ‚Ä¢ Pr√≥xima Manuten√ß√£o</div>

        <h3>Localiza√ß√£o</h3>
        <div id="localizacao" class="empty">-</div>
      </div>
      <div>
        <h3>Respons√°vel / Prestador</h3>
        <div id="resp" class="empty">-</div>
      </div>
    </div>

    <p style="margin-top:16px"><a id="reportar" class="chip">Reportar anomalia</a></p>
    <p style="font-size: 7px;">JCPG-2025 - Ver.:1.1</p>
    <div class="footer" id="ft"></div>
  </div>

  <!-- ====== CONFIG + L√ìGICA (TUDO em UM √öNICO <script>) ====== -->
  <script>
    // === CONFIG API (Apps Script) ===
    const API_URL   = "https://script.google.com/macros/s/AKfycbx7K_63QoHC_F8kR3X8NczNlkLNxebsmivoxDq1LEpgBRsvTqGnPGYxqUB2JqiiW2mkZg/exec";
    const API_TOKEN = "pncqalpha123"; // igual ao do GAS

    // ===== Helpers =====
    function qs(k){ return new URLSearchParams(location.search).get(k); }
    function el(s){ return document.querySelector(s); }
    function esc(s){ return (s||"").toString().replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function clean(v){ if(v===null||v===undefined)return"";let s=String(v).trim();s=s.replace(/^"+|"+$/g,"");if(s==="0"||s==="0,0"||s==="0.0"||s==='"0"')return"";return s; }
    function pick(obj,keys){for(const k of keys){if(obj[k]!==undefined&&String(obj[k]).trim()!=='')return obj[k];}return"";}
    function formatDateBR(s){
      const v=(s||"").toString().trim();
      if(!v) return "";
      const iso=v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(iso) return `${iso[3]}/${iso[2]}/${iso[1]}`;
      return v;
    }

    // ===== Chamada API =====
    async function fetchEquipById(id){
      const lic = window.__QRMANUT_LICENSE__ || {};
      const url = `${API_URL}?id=${encodeURIComponent(id)}&token=${encodeURIComponent(API_TOKEN)}&licenseKey=${encodeURIComponent(lic.licenseKey||'LIC-2025-0001')}`;
      console.log("üîó Chamando API:", url);
      const res = await fetch(url, { method:'GET', cache:'no-store' });
      const json = await res.json();
      console.log("üì¶ Resposta API:", json);
      if(!json.ok) throw new Error(json.error||'api_error');
      return json.data;
    }

    // ===== Render =====
    function render(eq){
      if(!eq){
        el("#titulo").textContent = "Ativo n√£o encontrado";
        return;
      }

      // T√≠tulo
      const id   = (eq.id || "").toString().trim();
      const nome = (eq.nome_do_equipamento || "").toString().trim();
      el("#titulo").textContent = (id || "Equipamento") + (nome ? " ‚Äì " + nome : "");

      // Meta
      const fabricante = (eq.fabricante || "").toString().trim();
      const modelo     = (eq.modelo     || "").toString().trim();
      el("#meta").innerHTML = [fabricante, modelo].filter(Boolean).join("<br>");

      // Caracter√≠sticas
      const capacidade = (eq.capacidade || "").toString().trim();
      const fla        = (eq.amperagem_nominal_fla || "").toString().trim();
      const voltagem   = (eq.voltagem || "").toString().trim();

      const pares = [
        ["Fabricante", fabricante],
        ["Modelo", modelo],
        ["Capacidade", capacidade],
        ["Amperagem Nominal (FLA)", fla],
        ["Voltagem", voltagem],
      ];

      const caracHTML = pares
        .filter(([k,v]) => v && v !== "-")
        .map(([k,v]) =>
          k === "Modelo"
            ? `<div><b>${esc(k)}:</b></div><div style="grid-column:1 / -1;word-break:break-word;overflow-wrap:anywhere;">${esc(v)}</div>`
            : `<div><b>${esc(k)}:</b></div><div>${esc(v)}</div>`
        )
        .join("") || "<div class='empty'>Sem dados</div>";

      el("#carac").innerHTML = caracHTML;

      // Plano
      const periodicidade = (eq.periodicidade || "").toString().trim();
      const prox          = formatDateBR(eq.proxima_manutencao);

      const pp = [];
      if (periodicidade) pp.push(`<b>Periodicidade:</b> ${esc(periodicidade)}`);
      if (prox)          pp.push(`<b>Pr√≥xima:</b> ${esc(prox)}`);
      el("#pp").innerHTML = pp.length ? pp.join("<br>") : "<span class='empty'>-</span>";

      // Localiza√ß√£o & Respons√°vel
      el("#localizacao").textContent = (eq.localizacao || "-");
      el("#resp").textContent        = (eq.prestador   || "-");

      // Rodap√© (timestamp)
      el("#ft").innerHTML = "√öltima atualiza√ß√£o: " + new Date().toLocaleString();
    }

    // ===== Boot =====
    async function main(){
      const idQ = qs("id");
      if(!idQ){
        el("#titulo").textContent = "Sem ID na URL";
        return;
      }
      try{
        const eq = await fetchEquipById(idQ);
        render(eq);
      }catch(e){
        console.error(e);
        el("#titulo").textContent = "Erro ao carregar dados";
      }
    }
    document.addEventListener("DOMContentLoaded", main);
  </script>

</body>
</html>
